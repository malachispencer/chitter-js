<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peeps | Chitter</title>
</head>
<body>
  <div>
    <h1>Peeps</h1>
  </div>
  <div>
    <a href="/sessions/destroy">Log Out</a>
  </div>
  <br>

  <div>
    <form id="peep-submit-form">
      <input id="peep-text" type="text" placeholder="Enter peep here" autocomplete="off" required>
      <input type="submit" value="Peep">
    </form>
  </div>

  <div id="peeps-container"></div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" 
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" 
    crossorigin="anonymous">
  </script>
  <script>

    $(document).ready(function() {

      getPeepsOnStartup();

      $('#peep-submit-form').submit((e) => {
        e.preventDefault();
        const peep = $('#peep-text').val();
        const timePosted = currentTime();
        $('#peep-text')[0].value = '';
        postPeep(peep, timePosted);
      });

      function getPeepsOnStartup() {
        $.ajax({
          url: '/peeps/initialize',
          method: 'get'
        })
        .done(data => {
          displayPeeps(data);
        });
      }

      function postPeep(text, timePosted) {
        const object = {
          text,
          timePosted
        }

        $.ajax({
          url: '/peeps',
          method: 'post',
          data: object
        })
        .done(data => {
            displayPeeps(data);
        });
      }

      function displayPeeps(peeps) {
        $('#peeps-container').empty();

        peeps.forEach(peep => {
          $('#peeps-container').append(wrapPeep(peep));
          $(window).scrollTop(0);
        });
      }

      function wrapPeep(peep) {
        const peepText = `<h4>${peep.text}</h4>`;
        const peepInfo = `<p>${peep.userName} - ${peep.timePosted} - ${peep.datePosted}<hr>`;
        const peepWrapped = $('<div class="peep"></div>').append(peepText).append(peepInfo);
        return peepWrapped;
      }

      function currentTime() {
        const date = new Date();
        const hours = (date.getHours() < 10 ? '0' : '') + date.getHours();
        const minutes = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
        return `${hours}:${minutes}`;
      }
      
    });

  </script>
</body>
</html>